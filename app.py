[... large code omitted for brevity ...]